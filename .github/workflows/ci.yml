name: CI

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - main
  # Allow this workflow to be called by other workflows (e.g., release)
  workflow_call:

permissions:
  contents: read

jobs:
  # ============================================================================
  # REQUIRED: CI policy guardrails (keeps ruleset-required check stable)
  # ============================================================================
  ci-policy:
    name: CI Policy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js (toolchain)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies (no lifecycle scripts)
        run: npm ci --ignore-scripts

      - name: Run CI policy check
        run: node scripts/ci-policy-check.js

  # ============================================================================
  # REQUIRED: Lockfile is stable under npm ci
  # ============================================================================
  lockfile:
    name: Lockfile Stable
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js (toolchain)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies (no lifecycle scripts)
        run: npm ci --ignore-scripts

      - name: Verify lockfile unchanged
        run: git diff --exit-code package-lock.json

  # ============================================================================
  # REQUIRED (PR only): semantic-release dry-run (config + version validation)
  # ============================================================================
  semantic-release-dry-run:
    name: semantic-release dry-run
    runs-on: ubuntu-latest
    needs: [ lockfile, build-artifact ]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Checkout code (full history)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup Node.js (toolchain)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies (no lifecycle scripts)
        run: npm ci --ignore-scripts

      - name: semantic-release dry-run (PR context)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release --dry-run --no-ci --verify-conditions false

  # ============================================================================
  # REQUIRED: Build Artifact (single source of truth for dist/)
  # ============================================================================
  build-artifact:
    name: Build Artifact (dist/)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js (toolchain)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies (no lifecycle scripts)
        run: npm ci --ignore-scripts

      - name: Build dist/
        run: npm run build

      - name: Verify dist artifacts
        run: |
          test -f dist/mcp-server.js || (echo "Missing dist/mcp-server.js" && exit 1)
          test -f dist/cli.js || (echo "Missing dist/cli.js" && exit 1)

      - name: Write dist manifest
        run: node scripts/dist-manifest.js --dist dist --write dist/manifest.json

      - name: Upload dist artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dist
          path: dist/
          if-no-files-found: error

  # ============================================================================
  # REQUIRED: Type Check (catches type errors that build might miss)
  # ============================================================================
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Type check
        run: npm run typecheck

  # ============================================================================
  # INFORMATIONAL: Security Audit (warns but doesn't block)
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run security audit
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=high 2>&1 | tee audit-results.txt || true
          if grep -q "found 0 vulnerabilities" audit-results.txt; then
            echo "No high/critical vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          else
            echo "Review audit results above for potential vulnerabilities." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # REQUIRED: Generated artifacts are up to date
  # ============================================================================
  verify-generated:
    name: Verify Generated Artifacts
  
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies (no lifecycle scripts)
        run: npm ci --ignore-scripts

      - name: Verify generated artifacts are up to date
        run: npm run verify:generated

  # ============================================================================
  # REQUIRED: Workflow Validation (blocks merge if workflows are invalid)
  # ============================================================================
  validate-workflows:
    name: Validate Workflows
    runs-on: ubuntu-latest
    needs: build-artifact
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Download build artifact (dist/)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist

      - name: Verify dist manifest
        run: node scripts/dist-manifest.js --dist dist --verify dist/manifest.json

      - name: Validate all workflows
        run: npm run validate:workflows

      - name: Validate workflow discovery (workflow_list/workflow_get)
        run: npm run validate:workflow-discovery

      - name: Summary
        if: success()
        run: |
          echo "## Workflow Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All workflow JSON files passed schema validation." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validated Workflows:" >> $GITHUB_STEP_SUMMARY
          for f in workflows/*.json; do
            echo "- $(basename $f)" >> $GITHUB_STEP_SUMMARY
          done

  # ============================================================================
  # REQUIRED: Build & Test
  # ============================================================================
  build-and-test:
    name: Build & Test (${{ matrix.os }}, Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    needs: build-artifact
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [ 20, 22.14.0 ]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Download build artifact (dist/)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist

      - name: Verify dist manifest
        run: node scripts/dist-manifest.js --dist dist --verify dist/manifest.json

      - name: Cross-platform test guardrails
        run: npm run -s codemod:test-platform-guard

      - name: Run unit and integration tests
        run: npx vitest run --exclude="tests/contract/**"

      - name: Upload coverage reports
        if: matrix.node-version == 20
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          directory: ./coverage
          flags: unittests
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # REQUIRED: Contract Tests (JSON-RPC API contract validation)
  # ============================================================================
  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    needs: build-artifact
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Download build artifact (dist/)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist

      - name: Verify dist manifest
        run: node scripts/dist-manifest.js --dist dist --verify dist/manifest.json

      - name: Cross-platform test guardrails
        run: npm run -s codemod:test-platform-guard

      - name: Run contract tests
        run: npx vitest run tests/contract/ --testTimeout=30000
        timeout-minutes: 10

  # ============================================================================
  # REQUIRED: E2E Tests
  # ============================================================================
  e2e-tests:
    name: E2E Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: build-artifact
    concurrency:
      group: workrail-e2e-fixed-3456
      cancel-in-progress: false
    strategy:
      matrix:
        node-version: [ 20, 22.14.0 ]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Download build artifact (dist/)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist

      - name: Verify dist manifest
        run: node scripts/dist-manifest.js --dist dist --verify dist/manifest.json

      - name: Install Playwright browsers with dependencies
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests (Chromium only in CI)
        run: npx playwright test --project=chromium --workers=1

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: playwright-report-node-${{ matrix.node-version }}
          path: ./playwright-report/
          retention-days: 30

  # ============================================================================
  # GATE: All required checks must pass
  # This job name must match the required_status_checks in the GitHub ruleset
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [ ci-policy, lockfile, build-artifact, semantic-release-dry-run, typecheck, verify-generated, validate-workflows, build-and-test, contract-tests, e2e-tests ]
    if: always()
    steps:
      - name: Check required jobs
        run: |
          echo "## CI Success Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check lockfile
          if [[ "${{ needs.lockfile.result }}" != "success" ]]; then
            echo "- Lockfile Stable: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Lockfile job failed"
            exit 1
          fi
          echo "- Lockfile Stable: PASSED" >> $GITHUB_STEP_SUMMARY

          # Check build-artifact
          if [[ "${{ needs.build-artifact.result }}" != "success" ]]; then
            echo "- Build Artifact: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Build Artifact job failed"
            exit 1
          fi
          echo "- Build Artifact: PASSED" >> $GITHUB_STEP_SUMMARY

          # Check semantic-release-dry-run (on PRs only)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ needs.semantic-release-dry-run.result }}" != "success" ]]; then
              echo "- semantic-release dry-run: FAILED" >> $GITHUB_STEP_SUMMARY
              echo "semantic-release dry-run job failed"
              exit 1
            fi
            echo "- semantic-release dry-run: PASSED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check typecheck
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "- Type Check: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Type check failed"
            exit 1
          fi
          echo "- Type Check: PASSED" >> $GITHUB_STEP_SUMMARY

          # Check verify-generated
          if [[ "${{ needs.verify-generated.result }}" != "success" ]]; then
            echo "- Verify Generated Artifacts: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Generated artifacts verification failed"
            exit 1
          fi
          echo "- Verify Generated Artifacts: PASSED" >> $GITHUB_STEP_SUMMARY
          
          # Check validate-workflows
          if [[ "${{ needs.validate-workflows.result }}" != "success" ]]; then
            echo "- Validate Workflows: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Workflow validation failed"
            exit 1
          fi
          echo "- Validate Workflows: PASSED" >> $GITHUB_STEP_SUMMARY
          
          # Check build-and-test
          if [[ "${{ needs.build-and-test.result }}" != "success" ]]; then
            echo "- Build & Test: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Build & Test job failed"
            exit 1
          fi
          echo "- Build & Test: PASSED" >> $GITHUB_STEP_SUMMARY
          
          # Check contract-tests
          if [[ "${{ needs.contract-tests.result }}" != "success" ]]; then
            echo "- Contract Tests: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Contract Tests job failed"
            exit 1
          fi
          echo "- Contract Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          
          # Check e2e-tests
          if [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then
            echo "- E2E Tests: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "E2E Tests job failed"
            exit 1
          fi
          echo "- E2E Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required CI checks passed." >> $GITHUB_STEP_SUMMARY
